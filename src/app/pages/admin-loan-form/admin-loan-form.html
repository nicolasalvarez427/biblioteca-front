<div class="container">
  <div class="card card-glass shadow-lg mx-auto" style="max-width: 700px;">
    <div class="card-header bg-transparent border-0 text-center pt-4 pb-2">
      <h3 class="fw-bold text-primary mb-0">
        ➕ Asignar Préstamo Manual
      </h3>
      <p class="text-muted">Selecciona un usuario y un libro disponible.</p>
    </div>

    <div class="card-body p-4">
      @if (isLoading()) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">Cargando libros y usuarios...</p>
        </div>
      } @else {
        <form [formGroup]="form" (ngSubmit)="onSubmit()">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="usuarioId" class="form-label fw-semibold">Estudiante</label>
              <select id="usuarioId" class="form-select" formControlName="usuarioId"
                      [class.is-invalid]="form.get('usuarioId')?.invalid && form.get('usuarioId')?.touched">
                <option value="" disabled>Selecciona un usuario...</option>
                @for (user of allUsers(); track user._id) {
                  <option [value]="user._id">{{ user.username }} ({{ user.email }})</option>
                }
              </select>
              @if (form.get('usuarioId')?.invalid && form.get('usuarioId')?.touched) {
                <small class="text-danger">Debes seleccionar un usuario.</small>
              }
            </div>

            <div class="col-md-6 mb-3">
              <label for="libroId" class="form-label fw-semibold">Libro Disponible</label>
              <select id="libroId" class="form-select" formControlName="libroId"
                      [class.is-invalid]="form.get('libroId')?.invalid && form.get('libroId')?.touched">
                <option value="" disabled>Selecciona un libro...</option>
                @for (book of availableBooks(); track book._id) {
                  <option [value]="book._id">{{ book.titulo }} (Stock: {{ book.stock }})</option>
                }
              </select>
              @if (form.get('libroId')?.invalid && form.get('libroId')?.touched) {
                <small class="text-danger">Debes seleccionar un libro.</small>
              }
            </div>
          </div>

          <div class="mb-4">
            <label for="fechaDevolucion" class="form-label fw-semibold">Fecha Límite de Devolución</label>
            <input type="date" id="fechaDevolucion" class="form-control" formControlName="fechaDevolucion"
                   [class.is-invalid]="form.get('fechaDevolucion')?.invalid && form.get('fechaDevolucion')?.touched">
            @if (form.get('fechaDevolucion')?.invalid && form.get('fechaDevolucion')?.touched) {
              <small class="text-danger">Fecha requerida.</small>
            }
          </div>

          <div class="d-flex justify-content-between pt-3 border-top">
            <button type="button" class="btn btn-outline-secondary px-4" (click)="volver()">
              ← Cancelar
            </button>
            <button type="submit" class="btn btn-primary px-4 fw-bold" [disabled]="form.invalid">
              ✨ Asignar Préstamo
            </button>
          </div>
        </form>
      }
    </div>
  </div>
</div>